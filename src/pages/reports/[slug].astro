---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
	const reports = await getCollection('reports');
	return reports.map(report => ({
		params: { slug: report.id },
		props: { report },
	}));
}

const { report } = Astro.props;
const { Content, headings: renderedHeadings } = await render(report);

function formatDate(date: Date) {
	return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
}

/** Use Astro's rendered headings which match the actual id attributes in the HTML */
const headings = renderedHeadings.filter(h => h.depth === 3);
---

<BaseLayout title={`${report.data.title} — Beyond Paralysis`} description={report.data.executiveSummary}>
	<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

		<!-- PDF Download Banner -->
		{report.data.pdfFilename && (
			<a
				href={`/pdfs/${report.data.pdfFilename}`}
				target="_blank"
				class="flex items-center gap-3 card-glow rounded-xl px-5 py-3 mb-8 no-underline hover:border-clinical-accent/30 transition group max-w-4xl"
			>
				<svg class="w-6 h-6 text-clinical-accent shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
					<path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
				</svg>
				<div>
					<span class="text-clinical-accent font-semibold text-sm group-hover:underline">Download Source PDF</span>
					<span class="block text-xs text-slate-500">{report.data.pdfFilename}</span>
				</div>
			</a>
		)}

		<!-- Header -->
		<header class="mb-10 max-w-4xl">
			<div class="flex items-center gap-3 mb-4">
				<span class="inline-block w-1 h-8 rounded-full bg-clinical-accent"></span>
				<span class="text-sm text-slate-500">{formatDate(report.data.pubDate)}</span>
				<span class="text-sm text-clinical-accent font-medium">Deep Dive</span>
			</div>
			<h1 class="text-3xl sm:text-4xl font-bold leading-tight">{report.data.title}</h1>
			<p class="text-slate-400 mt-4 leading-relaxed text-lg border-l-2 border-clinical-accent/30 pl-4 italic">{report.data.executiveSummary}</p>
		</header>

		<!-- Layout: Content + TOC sidebar -->
		<div class="grid grid-cols-1 lg:grid-cols-[1fr_240px] gap-10">

			<!-- Report Body -->
			<article class="report-content">
				<Content />
			</article>

			<!-- Sticky Table of Contents -->
			{headings.length > 0 && (
				<aside class="hidden lg:block">
					<nav class="sticky top-24">
						<div class="card-glow rounded-xl p-5">
							<h4 class="text-xs font-bold uppercase tracking-widest text-clinical-accent mb-4">On This Page</h4>
							<ul class="flex flex-col gap-2">
								{headings.map(h => (
									<li>
										<a
											href={`#${h.slug}`}
											class="text-xs text-slate-400 hover:text-clinical-accent transition-colors no-underline leading-snug block py-0.5"
										>
											{h.text}
										</a>
									</li>
								))}
							</ul>
						</div>
					</nav>
				</aside>
			)}
		</div>

		<!-- Back link -->
		<div class="mt-12 pt-6 border-t border-slate-700/50 max-w-4xl">
			<a href="/reports" class="text-sm text-clinical-accent hover:underline no-underline">&larr; All Deep Dives</a>
		</div>
	</main>
</BaseLayout>

<style is:global>
	/* Each ### section becomes a glowing card */
	.report-content h3 {
		color: white;
		font-size: 1.25rem;
		font-weight: 700;
		margin: 0;
		padding-bottom: 0.75rem;
		border-bottom: 1px solid rgba(0, 229, 255, 0.15);
		margin-bottom: 1rem;
		display: flex;
		align-items: center;
		gap: 0.625rem;
		scroll-margin-top: 6rem;
	}

	.report-content h3::before {
		content: '';
		display: inline-block;
		width: 3px;
		height: 1.25rem;
		border-radius: 2px;
		background: #00e5ff;
		flex-shrink: 0;
	}

	/* Wrap each section (h3 + its content) in a card-like visual block */
	.report-content {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	/* Section containers — created by the markdown structure */
	.report-content > * {
		/* Default styles for all direct children */
	}

	/* Style paragraphs */
	.report-content p {
		color: rgb(148, 163, 184); /* slate-400 */
		line-height: 1.75;
		margin-bottom: 0.75rem;
	}

	.report-content strong {
		color: white;
	}

	/* Style lists */
	.report-content ul,
	.report-content ol {
		color: rgb(148, 163, 184);
		line-height: 1.75;
		padding-left: 1.25rem;
		margin-bottom: 0.75rem;
	}

	.report-content ul {
		list-style-type: disc;
	}

	.report-content ol {
		list-style-type: decimal;
	}

	.report-content li {
		margin-bottom: 0.5rem;
		padding-left: 0.25rem;
	}

	.report-content li::marker {
		color: #00e5ff;
	}

	/* Links */
	.report-content a {
		color: #00e5ff;
		text-decoration: none;
	}
	.report-content a:hover {
		text-decoration: underline;
	}

	/* Section cards — group h3 + following content visually */
	.report-content .section-card {
		background: #1e293b;
		border: 1px solid rgba(0, 229, 255, 0.15);
		border-radius: 1rem;
		padding: 1.5rem;
		box-shadow:
			0 0 20px 0px rgba(0, 229, 255, 0.12),
			0 0 50px 0px rgba(0, 229, 255, 0.08),
			0 0 100px 0px rgba(0, 229, 255, 0.04),
			inset 0 1px 0 0 rgba(255, 255, 255, 0.05);
	}
</style>

<script>
	// Wrap each h3 section in a glowing card container
	document.addEventListener('DOMContentLoaded', () => {
		const content = document.querySelector('.report-content');
		if (!content) return;

		const children = Array.from(content.children);
		let currentCard: HTMLDivElement | null = null;
		const fragment = document.createDocumentFragment();

		for (const child of children) {
			if (child.tagName === 'H3') {
				// Start a new card
				currentCard = document.createElement('div');
				currentCard.className = 'section-card';
				currentCard.appendChild(child);
				fragment.appendChild(currentCard);
			} else if (currentCard) {
				currentCard.appendChild(child);
			} else {
				// Content before first h3
				fragment.appendChild(child);
			}
		}

		content.innerHTML = '';
		content.appendChild(fragment);
	});
</script>
