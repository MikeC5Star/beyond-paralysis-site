---
import { getCollection } from 'astro:content';

const thirtyDaysAgo = new Date();
thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

const news = (await getCollection('news'))
	.filter(item => item.data.pubDate >= thirtyDaysAgo)
	.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
	.slice(0, 20);

function formatDate(date: Date) {
	return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
}

/**
 * Category → colour map. Each category gets a distinct colour
 * so users can visually scan research areas at a glance.
 */
const categoryColors: Record<string, string> = {
	'Biomaterials & Regenerative Medicine': 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
	'Biomaterials':                         'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
	'Regenerative Medicine':                'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
	'Pharmacology':                         'bg-purple-500/20 text-purple-400 border-purple-500/30',
	'Pharmacology & Biomaterials':          'bg-purple-500/20 text-purple-400 border-purple-500/30',
	'Neuro-inflammation':                   'bg-rose-500/20 text-rose-400 border-rose-500/30',
	'Neuro-inflammation & Pharmacology':    'bg-rose-500/20 text-rose-400 border-rose-500/30',
	'Rehabilitation & Assistive Technology': 'bg-sky-500/20 text-sky-400 border-sky-500/30',
	'Robotics & Rehabilitation':            'bg-cyan-500/20 text-cyan-400 border-cyan-500/30',
	'Clinical Trial':                       'bg-amber-500/20 text-amber-400 border-amber-500/30',
	'Neuromodulation':                      'bg-teal-500/20 text-teal-400 border-teal-500/30',
	'Preclinical':                          'bg-violet-500/20 text-violet-400 border-violet-500/30',
	'Gene Therapy':                         'bg-pink-500/20 text-pink-400 border-pink-500/30',
	'Cellular Biology':                     'bg-indigo-500/20 text-indigo-400 border-indigo-500/30',
	'Neurology':                            'bg-fuchsia-500/20 text-fuchsia-400 border-fuchsia-500/30',
	'Bioengineering':                       'bg-lime-500/20 text-lime-400 border-lime-500/30',
	'Drug Delivery':                        'bg-orange-500/20 text-orange-400 border-orange-500/30',
	'Immunology':                           'bg-red-500/20 text-red-400 border-red-500/30',
	'Stem Cell Therapy':                    'bg-green-500/20 text-green-400 border-green-500/30',
	'Diagnostics':                          'bg-blue-500/20 text-blue-400 border-blue-500/30',
	'Machine Learning':                     'bg-slate-500/20 text-slate-300 border-slate-500/30',
};
const defaultColor = 'bg-slate-500/20 text-slate-400 border-slate-500/30';

function getCategoryColor(cat: string) {
	return categoryColors[cat] ?? defaultColor;
}

const techRatingColors = [
	'bg-green-500/20 text-green-400 border-green-500/30',   // 1 — easy
	'bg-lime-500/20 text-lime-400 border-lime-500/30',      // 2
	'bg-yellow-500/20 text-yellow-400 border-yellow-500/30', // 3
	'bg-orange-500/20 text-orange-400 border-orange-500/30', // 4
	'bg-red-500/20 text-red-400 border-red-500/30',          // 5 — expert
];

function getTechColor(rating: number) {
	return techRatingColors[rating - 1] ?? techRatingColors[2];
}
---

<!-- ===== MOBILE VERSION (below sm) ===== -->
<div class="sm:hidden flex flex-col items-center">
	<!-- Title -->
	<h2 class="text-lg font-bold mb-1 flex items-center gap-2">
		<span class="inline-block w-1 h-6 rounded-full bg-clinical-accent"></span>
		Daily Research News
	</h2>
	<p class="text-xs text-slate-400 mb-4">
		All research news: <a href="/news" class="text-clinical-accent hover:underline no-underline">here</a>
	</p>

	{news.length === 0 && (
		<p class="text-slate-400 text-sm">No news entries yet.</p>
	)}

	{news.length > 0 && (
		<div class="w-[80%] rounded-xl border border-slate-600/50 bg-clinical-card/40 backdrop-blur-sm p-3 news-container overflow-y-auto feed-scroll" id="mobile-news-container">
			<div class="flex flex-col gap-2" id="mobile-news-list">
				{news.map((item, idx) => (
					<div
						class={`news-card rounded-xl p-3 cursor-pointer transition-all duration-200 ${item.data.goldenRead ? 'card-glow-golden golden-read' : 'card-glow'}`}
						data-index={idx}
					>
						<div class="flex flex-wrap items-center gap-1.5 mb-1.5">
							{item.data.goldenRead && (
								<span class="text-[11px] font-semibold px-2.5 py-0.5 rounded-full border bg-yellow-500/20 text-yellow-400 border-yellow-500/30">
									★ Golden Read
								</span>
							)}
							{item.data.category.map(cat => (
								<span class={`text-[11px] font-semibold px-2.5 py-0.5 rounded-full border ${getCategoryColor(cat)}`}>
									{cat}
								</span>
							))}
							<span class={`text-[11px] font-semibold px-2.5 py-0.5 rounded-full border ${getTechColor(item.data.techRating)}`}>
								Tech: {item.data.techRating}/5
							</span>
						</div>
						<h3 class={`text-sm font-bold leading-snug ${item.data.goldenRead ? 'text-yellow-300' : 'text-white'}`}>
							{item.data.title}
						</h3>
						<div class="news-card-brief hidden mt-2">
							<p class="text-xs text-slate-400 leading-relaxed mb-1">{formatDate(item.data.pubDate)}</p>
							<p class="text-xs text-slate-400 leading-relaxed">
								{item.data.brief}
							</p>
							{item.data.sourceUrl && (
								<a
									href={item.data.sourceUrl}
									target="_blank"
									rel="noopener noreferrer"
									class="source-link inline-block mt-2 text-[11px] text-clinical-accent hover:underline no-underline"
								>
									Read full article &rarr; <span class="text-red-400">(warning: takes you to external news page)</span>
								</a>
							)}
						</div>
					</div>
				))}
			</div>
		</div>
	)}
</div>

<!-- ===== DESKTOP VERSION (sm and up) — unchanged ===== -->
<aside class="hidden sm:flex flex-col gap-1 h-full">
	<h2 class="text-lg font-bold mb-3 flex items-center gap-2">
		<span class="inline-block w-1 h-6 rounded-full bg-clinical-accent"></span>
		Live Research Alerts
	</h2>

	{news.length === 0 && (
		<p class="text-slate-400 text-sm">No news entries yet. Drop <code>.md</code> files into <code>src/content/news/</code> to get started.</p>
	)}

	<div class="flex flex-col gap-3 overflow-y-auto max-h-[600px] pr-1 feed-scroll">
		{news.map(item => (
			<div class={`rounded-xl p-4 transition-all relative ${item.data.goldenRead ? 'card-glow-golden golden-read' : 'card-glow'}`}>
				{item.data.goldenRead && (
					<span class="golden-tooltip">Mike's Recommended Read</span>
				)}
				<div class="flex flex-wrap items-center gap-1.5 mb-2">
					{item.data.goldenRead && (
						<span class="text-[11px] font-semibold px-2.5 py-0.5 rounded-full border bg-yellow-500/20 text-yellow-400 border-yellow-500/30">
							★ Golden Read
						</span>
					)}
					{item.data.category.map(cat => (
						<span class={`text-[11px] font-semibold px-2.5 py-0.5 rounded-full border ${getCategoryColor(cat)}`}>
							{cat}
						</span>
					))}
					<span class={`text-[11px] font-semibold px-2.5 py-0.5 rounded-full border ${getTechColor(item.data.techRating)}`}>
						Tech: {item.data.techRating}/5
					</span>
				</div>
				<h3 class={`text-sm font-bold leading-snug ${item.data.goldenRead ? 'text-yellow-300' : 'text-white'}`}>
					{item.data.title}
				</h3>
				<p class="text-xs text-slate-400 mt-1.5 leading-relaxed">{formatDate(item.data.pubDate)}</p>
				<p class="text-xs text-slate-400 mt-1 leading-relaxed line-clamp-3">
					{item.data.brief}
				</p>
				{item.data.sourceUrl && (
					<a
						href={item.data.sourceUrl}
						target="_blank"
						rel="noopener noreferrer"
						class="inline-block mt-2 text-[11px] text-clinical-accent hover:underline no-underline"
					>
						Read full article &rarr; <span class="text-red-400">(warning: takes you to external page)</span>
					</a>
				)}
			</div>
		))}
	</div>

	{news.length > 0 && (
		<a href="/news" class="mt-3 text-center text-xs text-clinical-accent hover:underline no-underline">
			View all recent news &rarr;
		</a>
	)}
</aside>

<style>
	.feed-scroll::-webkit-scrollbar {
		width: 4px;
	}
	.feed-scroll::-webkit-scrollbar-track {
		background: transparent;
	}
	.feed-scroll::-webkit-scrollbar-thumb {
		background: rgba(0, 229, 255, 0.3);
		border-radius: 4px;
	}
	.feed-scroll::-webkit-scrollbar-thumb:hover {
		background: rgba(0, 229, 255, 0.5);
	}
	.feed-scroll {
		scrollbar-width: thin;
		scrollbar-color: rgba(0, 229, 255, 0.3) transparent;
	}

	.golden-read {
		position: relative;
	}
	.golden-tooltip {
		position: absolute;
		top: -32px;
		left: 50%;
		transform: translateX(-50%);
		background: rgba(255, 193, 7, 0.95);
		color: #1e293b;
		font-size: 11px;
		font-weight: 700;
		padding: 4px 12px;
		border-radius: 6px;
		white-space: nowrap;
		opacity: 0;
		pointer-events: none;
		transition: opacity 0.2s ease;
		z-index: 10;
	}
	.golden-tooltip::after {
		content: '';
		position: absolute;
		top: 100%;
		left: 50%;
		transform: translateX(-50%);
		border: 5px solid transparent;
		border-top-color: rgba(255, 193, 7, 0.95);
	}
	.golden-read:hover .golden-tooltip {
		opacity: 1;
	}

	/* Mobile news card expanded state */
	.news-card.expanded {
		border-color: rgba(0, 229, 255, 0.3);
	}

	.news-card.expanded .news-card-brief {
		display: block;
	}
</style>

<script>
	function initMobileNewsFeed() {
		const container = document.getElementById('mobile-news-container');
		const cards = document.querySelectorAll('.news-card');
		if (!container || cards.length === 0) return;

		// Calculate container height: 2.5 collapsed cards + gaps
		// Half-visible card signals "scroll for more"
		const firstCard = cards[0] as HTMLElement;
		const cardHeight = firstCard.offsetHeight;
		const gap = 8; // gap-2 = 0.5rem = 8px
		const containerPadding = 24; // p-3 = 12px * 2
		const containerHeight = (cardHeight * 2.5) + (gap * 2) + containerPadding;
		container.style.maxHeight = containerHeight + 'px';

		// Stop source links from triggering accordion
		container.querySelectorAll('.source-link').forEach(link => {
			link.addEventListener('click', (e) => e.stopPropagation());
		});

		// Accordion behaviour
		cards.forEach(card => {
			card.addEventListener('click', (e) => {
				const target = e.target as HTMLElement;
				// Don't toggle if clicking a link inside
				if (target.tagName === 'A' || target.closest('a')) return;

				const isExpanded = card.classList.contains('expanded');

				// Close all cards
				cards.forEach(c => c.classList.remove('expanded'));

				// Open clicked card if it was closed
				if (!isExpanded) {
					card.classList.add('expanded');
					// Scroll the opened card into view within the container
					(card as HTMLElement).scrollIntoView({ behavior: 'smooth', block: 'nearest' });
				}
			});
		});
	}

	// Run on initial load and on Astro page transitions
	initMobileNewsFeed();
	document.addEventListener('astro:after-swap', initMobileNewsFeed);
</script>
